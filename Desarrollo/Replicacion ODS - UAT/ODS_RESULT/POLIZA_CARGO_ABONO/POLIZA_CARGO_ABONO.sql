-- ------------------------------------------------------------------------------------
-- Paso 4: Exportar los archivos que sufrieron un cambio o son nuevos
-- ------------------------------------------------------------------------------------

CREATE OR REPLACE TABLE `iter-data-storage-pv-uat.temp.TMP_POLIZA_CARGO_ABONO_EXPORT_GCP_PRUEBA`
PARTITION BY DATE_TRUNC(FECHA_MODIFICACION_REGISTRO,YEAR)
CLUSTER BY ID_PRODUCTO
AS
WITH TMP_AGENTE AS (
SELECT
COD_AGENTE
,CODIGO_SUPERVISOR
,CATEGORIA AS CATEGORIA_AGENTE
,DATE(FECHA_CREACION_REGISTRO) AS FECHA_OPERACION_INICIO
,COALESCE(LEAD(DATE_SUB(DATE(FECHA_CREACION_REGISTRO), INTERVAL 1 DAY))OVER(PARTITION BY COD_AGENTE ORDER BY FECHA_CREACION_REGISTRO ASC),CURRENT_DATE("America/Lima")) AS FECHA_OPERACION_FIN
FROM `iter-data-storage-pv-uat.goldenrecord_data.HD_ESTRUCTURA_COMERCIAL`
)
,TMP_POLIZA_OPERACION_AGENTE AS (
SELECT
NUMERO_POLIZA
,COD_AGENTE_FINAL
,DATE(FECHA_OPERACION_MOVIMIENTO) AS FECHA_OPERACION_INICIO
,COALESCE(LEAD(DATE_SUB(DATE(FECHA_OPERACION_MOVIMIENTO), INTERVAL 1 DAY))OVER(PARTITION BY NUMERO_POLIZA ORDER BY TIMESTAMP(FECHA_OPERACION_MOVIMIENTO) ASC),CURRENT_DATE("America/Lima")) AS FECHA_OPERACION_FIN
FROM (SELECT * FROM `iter-data-storage-pv-uat.goldenrecord_data.POLIZA_OPERACION_AGENTE`
      WHERE STATUS_OPERATION='Applied operation'
--      QUALIFY(ROW_NUMBER()OVER(PARTITION BY NUMERO_POLIZA,COD_AGENTE_FINAL ORDER BY FECHA_OPERACION ASC))=1
     ) A --> ACSEL -E ,VIDA, HISTORIA DE RENTA NO HAY
--WHERE --NUMERO_POLIZA='690207'AND
--STATUS_OPERATION='Applied operation'
--ORDER BY NUMERO_POLIZA DESC
)
SELECT
  PCA.NUMERO_POLIZA
 ,PCA.FRECUENCIA_PAGO
 ,PCA.ID_PRODUCTO
 ,PCA.NUMERO_ABONO
 ,PCA.NUMERO_CARGO
 ,PCA.ID_DEVOLUCION
 ,PCA.MONTO_MONEDA
 ,PCA.MONTO_CANTIDAD
 ,PCA.MONTO_CANTIDAD_ABONO_PEN
 ,PCA.FECHA_REGISTRO_CAJA_P
 ,PCA.CARGO_PERIODO_COBRANZA
 ,CASE WHEN PCA.NUM_VIA_PAGO_COBRO LIKE '60%' THEN '600'
       ELSE PCA.NUM_VIA_PAGO_COBRO END AS NUM_VIA_PAGO_COBRO
 ,PCA.ESTADO_ABONO
 ,PCA.TIPO_CAMBIO_DIA_ABONO
 ,PCA.FECHA_MODIFICACION_REGISTRO
 ,POA.COD_AGENTE_FINAL
--,COALESCE(B.CODIGO_SUPERVISOR,ECC.CODIGO_SUPERVISOR) AS COD_SUPERVISOR_AGENTE_FINAL
--,COALESCE(B.CATEGORIA_AGENTE,ECC.CATEGORIA) AS CATEGORIA_AGENTE
,B.CODIGO_SUPERVISOR AS COD_SUPERVISOR_AGENTE_FINAL
,B.CATEGORIA_AGENTE AS CATEGORIA_AGENTE
--,PCA.FECHA_MODIFICACION_REGISTRO
 FROM `iter-data-storage-pv-uat.goldenrecord_data.POLIZA_CARGO_ABONO` PCA
 LEFT JOIN TMP_POLIZA_OPERACION_AGENTE POA
        ON PCA.NUMERO_POLIZA=POA.NUMERO_POLIZA
       AND PCA.FECHA_REGISTRO_CAJA_P BETWEEN FECHA_OPERACION_INICIO AND FECHA_OPERACION_FIN
 LEFT JOIN TMP_AGENTE B
        ON POA.COD_AGENTE_FINAL=CAST(B.COD_AGENTE AS STRING)
       AND DATE(FECHA_REGISTRO_CAJA_P) BETWEEN B.FECHA_OPERACION_INICIO AND B.FECHA_OPERACION_FIN
-- LEFT JOIN `iter-data-storage-pv-uat.goldenrecord_data.ESTRUCTURA_COMERCIAL` ECC
--       ON CAST(ECC.COD_AGENTE AS STRING)=CAST(POA.COD_AGENTE_FINAL AS STRING)
WHERE NOMBRE_GRUPO_PRODUCTO IN ( 'VEHICULAR','VIDA')
  AND PCA.NUMERO_POLIZA IS NOT NULL
;

-- ------------------------------------------------------------------------------------
-- Paso 4: Exportar los archivos que sufrieron un cambio o son nuevos
-- ------------------------------------------------------------------------------------
EXPORT DATA OPTIONS(
URI='gs://interseguro-datalake-prd-landing/DEV/ODS/POLIZA_CARGO_ABONO/POLIZA_CARGO_ABONO-*.csv.gz',
FORMAT='CSV',
COMPRESSION='GZIP',
overwrite=true,
header=false,
field_delimiter='~'
)
AS
SELECT
 NUMERO_POLIZA
,FRECUENCIA_PAGO
,ID_PRODUCTO
,NUMERO_ABONO
,NUMERO_CARGO
,ID_DEVOLUCION
,MONTO_MONEDA
,MONTO_CANTIDAD
,MONTO_CANTIDAD_ABONO_PEN
,FECHA_REGISTRO_CAJA_P
,CARGO_PERIODO_COBRANZA
,NUM_VIA_PAGO_COBRO
,ESTADO_ABONO
,TIPO_CAMBIO_DIA_ABONO
,COD_AGENTE_FINAL AS COD_AGENTE
,COD_SUPERVISOR_AGENTE_FINAL AS COD_SUPERVISOR
,CATEGORIA_AGENTE
--FROM `iter-data-storage-pv-uat.goldenrecord_data.POLIZA_CARGO_ABONO`
FROM  `iter-data-storage-pv-uat.temp.TMP_POLIZA_CARGO_ABONO_EXPORT_GCP_PRUEBA`
--WHERE NOMBRE_GRUPO_PRODUCTO IN('VIDA','VEHICULAR')
--WHERE NOMBRE_GRUPO_PRODUCTO ='VEHICULAR'

;

DROP TABLE  IF EXISTS `iter-data-storage-pv-uat.temp.TMP_POLIZA_CARGO_ABONO_EXPORT_GCP_PRUEBA`;

